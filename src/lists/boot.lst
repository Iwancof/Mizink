     1                                  ; MizinkOS
     2                                  ; Written by @Iwancof_ptr in 2020/4/28
     3                                  
     4                                  %include	"settings/common_define.s"
     1                              <1> SECT_SIZE	equ	512
     2                              <1> E820_RECORD_SIZE	equ	20
     3                              <1> BOOT_LOAD	equ	0x7C00
     4                              <1> BOOT_STACK	equ	BOOT_LOAD
     5                              <1> BOOT_SIZE	equ	1024*8
     6                              <1> BOOT_SECT	equ	BOOT_SIZE/SECT_SIZE
     7                              <1> BOOT_END	equ	BOOT_LOAD+BOOT_SIZE
     8                              <1> KERNEL_LOAD	equ	0x0001_0000
     9                              <1> KERNEL_SIZE	equ	0x0000_6000
    10                              <1> KERNEL_SECT	equ	KERNEL_SIZE/SECT_SIZE
    11                              <1> KERNEL_END	equ	KERNEL_LOAD+KERNEL_SIZE
    12                              <1> VGA_SEQ_ADR	equ	0x03C4
    13                              <1> VGA_SEQ_DAT	equ	0x03C5
    14                              <1> VGA_GRA_ADR	equ	0x03CE
    15                              <1> VGA_GRA_DAT	equ	0x03CF
     5                                  %include	"settings/macro.s"
     1                              <1> %macro	cdecl	1-*.nolist
     2                              <1> 	%rep	%0 - 1
     3                              <1> 		push	%{-1:-1}
     4                              <1> 		%rotate -1
     5                              <1> 	%endrep
     6                              <1> 	%rotate -1
     7                              <1> 		call %1
     8                              <1> 	%if 1 < %0
     9                              <1> 		add	sp,(__BITS__ >> 3) * (%0 - 1)
    10                              <1> 	%endif
    11                              <1> %endmacro
     6                                  %include	"settings/structs.s"
     1                              <1> struc drive
     2 00000000 <res 00000002>      <1> 	.no	resw	1	; ÉhÉâÉCÉuî‘çÜ
     3 00000002 <res 00000002>      <1> 	.cyln	resw	1	; ÉVÉäÉìÉ_êî
     4 00000004 <res 00000002>      <1> 	.head	resw	1	; ÉwÉbÉ_êî
     5 00000006 <res 00000002>      <1> 	.sect	resw	1	; ÉZÉNÉ^êî
     6                              <1> endstruc
     7                                  
     8                                  ORG	BOOT_LOAD
     9                                  
    10                                  boot_entry:
    11 00000000 EB3C                    	jmp	ipl
    12 00000002 90                      	times	3 - ($ - $$) db	0x90
    13 00000003 4F454D2D4E414D45        	db	'OEM-NAME'
    14                                  	
    15 0000000B 0002                    	dw	512
    16 0000000D 01                      	db	1
    17 0000000E 2000                    	dw	32
    18 00000010 02                      	db	2
    19 00000011 0002                    	dw	512
    20 00000013 F0FF                    	dw	0xFFF0
    21 00000015 F8                      	db	0xF8
    22 00000016 0001                    	dw	256
    23 00000018 1000                    	dw	0x10
    24 0000001A 0200                    	dw	2
    25 0000001C 00000000                	dd	0
    26                                  
    27 00000020 00000000                	dd	0
    28 00000024 80                      	db	0x80
    29 00000025 00                      	db	0
    30 00000026 29                      	db	0x29
    31 00000027 EFBE0000                	dd	0xBEEF
    32 0000002B 424F4F5441424C4520-     	db	'BOOTABLE   '
    32 00000034 2020               
    33 00000036 4641543136202020        	db	'FAT16   '
    34                                  
    35 0000003E FA                      ipl:	cli	; Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢
    36                                  
    37 0000003F B80000                  	mov	ax, 0x0000	; „Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø
    38 00000042 8ED8                    	mov	ds, ax
    39 00000044 8EC0                    	mov	es, ax
    40 00000046 8ED0                    	mov	ss, ax
    41 00000048 BC007C                  	mov	sp, BOOT_STACK
    42                                  	; ÂêÑÁ®Æ„Çª„Ç∞„É°„É≥„Éà„É¨„Ç∏„Çπ„Çø„ÇíÂàùÊúüÂåñ
    43                                  	
    44 0000004B FB                      	sti
    45 0000004C 8816[9E00]              	mov	[BOOT_DRIVE + drive.no], dl
    46                                  	; dl „Å´„ÅØ„Éâ„É©„Ç§„Éñ„ÅÆÁï™Âè∑„Åå„Çª„ÉÉ„Éà„Åï„Çå„Å¶„ÅÑ„Çã
    47                                  	
    48 00000050 BB0F00                  	mov	bx, BOOT_SECT - 1
    49                                  	; ‰Ωï„Çª„ÇØ„ÇøË™≠„ÇÄ„Åã
    50 00000053 B9007E                  	mov	cx, BOOT_LOAD + SECT_SIZE
    51                                  	; „Å©„Åì„Åã„Çâ„ÄÄË™≠„ÇÄ„Åã
    52 00000056 515368[9E00]E84800-     	cdecl	read_chs, BOOT_DRIVE, bx, cx
    52 0000005E 83C406             
    53                                  	; AX = (Âëº„Çì„Å†„Çª„ÇØ„ÇøÊï∞)
    54                                  
    55 00000061 39D8                    	cmp	ax, bx
    56 00000063 740C                    	je	.10E	; ÊàêÂäü
    57                                  	
    58 00000065 68[8800]E8870083C4-     	cdecl	puts, .e0
    58 0000006D 02                 
    59 0000006E E8A000                  	call	reboot
    60                                  .10E:
    61 00000071 E90206                  	jmp	main_boot_program	
    62                                  
    63                                  		
    64 00000074 5265616C206D6F6465-     .s0	db	"Real mode started", 0x0D, 0x0A, 0, 
    64 0000007D 20737461727465640D-
    64 00000086 0A00               
    65 00000088 436F756C64206E6F74-     .e0	db	"Could not read stage2", 0
    65 00000091 207265616420737461-
    65 0000009A 67653200           
    66                                  
    67                                  ALIGN	2, 	db	0
    68                                  BOOT_DRIVE:	
    69                                  	istruc drive
    70                                  	; ÂàùÊúüÂÄ§(ÊúÄÂàù„ÅÆread_chs„Åß‰ΩøÁî®)
    71                                  	; sect„Åå2„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÅÆ„ÅØ2„Çª„ÇØ„ÇøÁõÆ„Åã„ÇâË™≠„ÅøËæº„Åø„Åü„ÅÑ„Åã„Çâ
    72 0000009E 0000                    		at drive.no,	dw	0
    73 000000A0 0000                    		at drive.cyln,	dw	0
    74 000000A2 0000                    		at drive.head,	dw	0
    75 000000A4 0200                    		at drive.sect,	dw	2
    76                                  	iend
    77                                  
    78                                  %include	"modules/real/read_chs.s"
     1                              <1> read_chs:
     2                              <1> ; read_chs(drive_struct_address, read_sector[sect], dst[sect])
     3 000000A6 55                  <1> 	push	bp
     4 000000A7 89E5                <1> 	mov	bp, sp
     5                              <1> 
     6 000000A9 6A03                <1> 	push	3	; Ë©¶Ë°åÂõûÊï∞
     7 000000AB 6A00                <1> 	push	0
     8                              <1> 
     9 000000AD 53                  <1> 	push	bx
    10 000000AE 51                  <1> 	push	cx
    11 000000AF 52                  <1> 	push	dx
    12 000000B0 06                  <1> 	push	es
    13 000000B1 56                  <1> 	push	si
    14                              <1> 
    15 000000B2 8B7604              <1> 	mov	si, [bp + 4]	; „Éâ„É©„Ç§„ÉñÊßãÈÄ†‰Ωì„Ç¢„Éâ„É¨„Çπ
    16 000000B5 8A6C02              <1> 	mov	ch, [si + drive.cyln + 0]
    17 000000B8 8A4C03              <1> 	mov	cl, [si + drive.cyln + 1]
    18 000000BB C0E106              <1> 	shl	cl, 6
    19                              <1> 	; cl„ÅÆ‰∏ã‰Ωç2bit„Çích„Å´„Å§„Å™„Åí„Å¶„ÅÑ„Çã
    20 000000BE 0A4C06              <1> 	or	cl, [si + drive.sect]
    21                              <1> 	; cl„ÅÆ‰∏ã‰Ωç6bit„ÅØsect„Çí„Çª„ÉÉ„Éà
    22                              <1> 
    23 000000C1 8A7404              <1> 	mov	dh, [si + drive.head]
    24 000000C4 8A14                <1> 	mov	dl, [si + drive.no]
    25                              <1> 	
    26 000000C6 B80000              <1> 	mov	ax, 0x0000
    27 000000C9 8EC0                <1> 	mov	es, ax
    28                              <1> 
    29 000000CB 8B5E08              <1> 	mov	bx, [bp + 8]	; bx = dst
    30                              <1> .10L:
    31 000000CE B402                <1> 	mov	ah, 0x02
    32 000000D0 8A4606              <1> 	mov	al, [bp + 6]	; al = sector
    33                              <1> 
    34 000000D3 CD13                <1> 	int	0x13		; BIOS„Ç≥„Éº„É´
    35 000000D5 7304                <1> 	jnc	.11E
    36                              <1> 	; „Ç®„É©„Éº„Å™„ÇâCarry„Éï„É©„Ç∞„Åå„Çª„ÉÉ„Éà„Åï„Çå„Çã
    37                              <1> 	; https://en.wikipedia.org/wiki/INT_13H#INT_13h_AH=02h:_Read_Sectors_From_Drive
    38                              <1> 
    39 000000D7 B000                <1> 	mov	al, 0
    40 000000D9 EB0C                <1> 	jmp	.10E
    41                              <1> .11E:	; „Ç®„É©„Éº
    42 000000DB 3C00                <1> 	cmp	al, 0
    43 000000DD 7508                <1> 	jne	.10E
    44                              <1> 
    45 000000DF FF4EFE              <1> 	dec	word [bp - 2]	; Ë©¶Ë°åÂõûÊï∞
    46 000000E2 75EA                <1> 	jnz	.10L
    47 000000E4 B80000              <1> 	mov	ax, 0		; „Ç®„É©„Éº
    48                              <1> .10E:
    49 000000E7 B400                <1> 	mov	ah, 0
    50                              <1> 
    51 000000E9 5E                  <1> 	pop	si
    52 000000EA 07                  <1> 	pop	es
    53 000000EB 5A                  <1> 	pop	dx
    54 000000EC 59                  <1> 	pop	cx
    55 000000ED 5B                  <1> 	pop	bx
    56                              <1> 	
    57 000000EE 89EC                <1> 	mov	sp, bp
    58 000000F0 5D                  <1> 	pop	bp
    59                              <1> 
    60 000000F1 C3                  <1> 	ret
    79                                  %include	"modules/real/puts.s"
     1                              <1> puts:
     2                              <1> ; puts(string_address)
     3                              <1> ; draw until 0
     4 000000F2 55                  <1> 	push	bp
     5 000000F3 89E5                <1> 	mov	bp, sp
     6                              <1> 
     7 000000F5 50                  <1> 	push	ax
     8 000000F6 53                  <1> 	push	bx
     9 000000F7 56                  <1> 	push	si
    10                              <1> 
    11 000000F8 8B7604              <1> 	mov	si, [bp + 4]
    12                              <1> 
    13 000000FB B40E                <1> 	mov	ah, 0x0E
    14                              <1> 	; ÊñáÂ≠óÊèèÁîª„É¢„Éº„Éâ
    15 000000FD BB0000              <1> 	mov	bx, 0x0000
    16                              <1> 	; Ëâ≤
    17                              <1> 
    18 00000100 FC                  <1> 	cld	; Âä†ÁÆóÊñπÂêë„ÇíÊ≠£„Å´
    19                              <1> .10L:
    20 00000101 AC                  <1> 	lodsb
    21                              <1> 	; AL =* SI; SI++
    22 00000102 3C00                <1> 	cmp	al, 0
    23 00000104 7404                <1> 	je	.10E
    24                              <1> 
    25 00000106 CD10                <1> 	int	0x10
    26 00000108 EBF7                <1> 	jmp	.10L
    27                              <1> 	; „Åæ„Å†ÊèèÁîª
    28                              <1> .10E:
    29 0000010A 5E                  <1> 	pop	si
    30 0000010B 5B                  <1> 	pop	bx
    31 0000010C 58                  <1> 	pop	ax
    32                              <1> 
    33 0000010D 89EC                <1> 	mov	sp, bp
    34 0000010F 5D                  <1> 	pop	bp
    35                              <1> 
    36 00000110 C3                  <1> 	ret
    80                                  %include	"modules/real/reboot.s"
     1                              <1> reboot:
     2 00000111 68[2401]E8DBFF83C4- <1> 	cdecl	puts, .s0
     2 00000119 02                  <1>
     3                              <1> 
     4                              <1> .10L:
     5 0000011A B410                <1> 	mov	ah, 0x10
     6 0000011C CD16                <1> 	int	0x16
     7                              <1> 	; 16H:10H „Ç≠„ÉºÂÖ•Âäõ„ÄÇ„É™„Ç∂„É´„Éà„ÅØAL
     8                              <1> 
     9 0000011E 3C20                <1> 	cmp	al, ' '
    10 00000120 75F8                <1> 	jne	.10L
    11                              <1> 
    12 00000122 CD19                <1> 	int	0x19
    13                              <1> 
    14 00000124 0A0D50555348205350- <1> .s0:	db	0x0A, 0x0D, "PUSH SPACE KEY TO REBOOT", 0x0A, 0x0D, 0
    14 0000012D 414345204B45592054- <1>
    14 00000136 4F205245424F4F540A- <1>
    14 0000013F 0D00                <1>
    81                                  
    82 00000141 00<rept>                	times	510 - ($ - $$)	db	0x00
    83 000001FE 55AA                    	db	0x55, 0xAA
    84                                  
    85                                  FONT:
    86 00000200 0000                    .seg:	dw	0
    87 00000202 0000                    .off:	dw	0
    88                                  ACPI_DATA:
    89 00000204 00000000                .adr:	dd	0
    90 00000208 00000000                .len:	dd	0
    91                                  
    92                                  %include	"modules/real/get_drive_param.s"
     1                              <1> get_drive_param:
     2                              <1> ; get_drive_param(drive_dst_adr)
     3 0000020C 55                  <1> 	push	bp
     4 0000020D 89E5                <1> 	mov	bp, sp
     5                              <1> 
     6 0000020F 06                  <1> 	push	es
     7 00000210 53                  <1> 	push	bx
     8 00000211 51                  <1> 	push	cx
     9 00000212 52                  <1> 	push	dx
    10 00000213 56                  <1> 	push	si
    11 00000214 57                  <1> 	push	di
    12                              <1> 
    13 00000215 8B7604              <1> 	mov	si, [bp + 4]
    14                              <1> 
    15 00000218 B80000              <1> 	mov	ax, 0
    16 0000021B 8EC0                <1> 	mov	es, ax
    17 0000021D 89C7                <1> 	mov	di, ax
    18                              <1> 
    19 0000021F 8A14                <1> 	mov	dl, [si + drive.no]
    20                              <1> 	; drive index
    21 00000221 B408                <1> 	mov	ah, 0x08
    22                              <1> 	; "read_drive_parameters"
    23 00000223 B90000              <1> 	mov	cx, 0
    24 00000226 CD13                <1> 	int	0x13
    25                              <1> 	; ES:DI„ÇíË™≠„ÇÄ
    26                              <1> 
    27 00000228 7224                <1> 	jc	.10F
    28                              <1> 
    29 0000022A 89C8                <1> 	mov	ax, cx
    30 0000022C 83E03F              <1> 	and	ax, 0b00111111
    31 0000022F 894406              <1> 	mov	[si + drive.sect], ax
    32                              <1> 	; „Çª„ÇØ„ÇøÊï∞
    33 00000232 C0E906              <1> 	shr	cl, 6
    34 00000235 C1C908              <1> 	ror	cx, 8	; CL„Å®CH„ÅÆ‰∫§Êèõ
    35 00000238 83C101              <1> 	add	cx, 1
    36 0000023B 894C02              <1> 	mov	[si + drive.cyln], cx
    37                              <1> 	; „Ç∑„É™„É≥„ÉÄÊï∞
    38                              <1> 
    39 0000023E 89D3                <1> 	mov	bx, dx
    40 00000240 C1EB08              <1> 	shr	bx, 8	; BX = DH
    41 00000243 83C301              <1> 	add 	bx, 1
    42 00000246 895C04              <1> 	mov	[si + drive.head], bx
    43                              <1> 
    44 00000249 B80100              <1> 	mov	ax, 1
    45                              <1> 	; ÊàêÂäü
    46                              <1> 
    47 0000024C EB03                <1> 	jmp	.10E
    48                              <1> .10F:	; Â§±Êïó
    49 0000024E B80000              <1> 	mov	ax, 0
    50                              <1> .10E:
    51 00000251 5F                  <1> 	pop	di
    52 00000252 5E                  <1> 	pop	si
    53 00000253 5A                  <1> 	pop	dx
    54 00000254 59                  <1> 	pop	cx
    55 00000255 5B                  <1> 	pop	bx
    56 00000256 07                  <1> 	pop	es
    57                              <1> 
    58 00000257 89EC                <1> 	mov	sp, bp
    59 00000259 5D                  <1> 	pop	bp
    60                              <1> 
    61 0000025A C3                  <1> 	ret
    93                                  %include	"modules/real/get_font_adr.s"
     1                              <1> get_font_adr:
     2                              <1> ; get_font_adr(dst_font_adr)
     3 0000025B 55                  <1> 	push	bp
     4 0000025C 89E5                <1> 	mov	bp, sp
     5                              <1> 	
     6 0000025E 56                  <1> 	push	si
     7 0000025F 50                  <1> 	push	ax
     8 00000260 53                  <1> 	push	bx
     9 00000261 06                  <1> 	push	es
    10 00000262 55                  <1> 	push	bp
    11                              <1> 
    12 00000263 8B7604              <1> 	mov	si, [bp + 4]
    13 00000266 B83011              <1> 	mov	ax, 0x1130
    14 00000269 B706                <1> 	mov	bh, 0x06
    15                              <1> 	; ‰∏ÄÊñáÂ≠óÂΩì„Åü„Çä„ÅÆ„Éê„Ç§„ÉàÊï∞
    16 0000026B CD10                <1> 	int	0x10
    17                              <1> 	; 10H:11H -- "Change text mode character set"
    18                              <1> 	; ES:BP„Å´„Éï„Ç©„É≥„Éà„Ç¢„Éâ„É¨„Çπ„ÅåÂÖ•„Çã
    19                              <1> 
    20 0000026D 8C04                <1> 	mov	[si + 0], es	; „Çª„Ç∞„É°„É≥„Éà
    21 0000026F 896C02              <1> 	mov	[si + 2], bp	; „Ç™„Éï„Çª„ÉÉ„Éà
    22                              <1> 
    23 00000272 5D                  <1> 	pop	bp
    24 00000273 07                  <1> 	pop	es
    25 00000274 5B                  <1> 	pop	bx
    26 00000275 58                  <1> 	pop	ax
    27 00000276 5E                  <1> 	pop	si
    28                              <1> 	
    29 00000277 89EC                <1> 	mov	sp, bp
    30 00000279 5D                  <1> 	pop	bp
    31                              <1> 
    32 0000027A C3                  <1> 	ret
    33                              <1> 
    34                              <1> 	
    35                              <1> 
    94                                  %include	"modules/real/itoa.s"
     1                              <1> itoa:
     2                              <1> ; itoa(num, buf, buf_size, radix, flag)
     3 0000027B 55                  <1> 	push	bp
     4 0000027C 89E5                <1> 	mov	bp, sp
     5                              <1> 
     6 0000027E 60                  <1> 	pusha
     7                              <1> 
     8 0000027F 8B5E0C              <1> 	mov	bx, word [bp + 12]
     9 00000282 8B4E08              <1> 	mov	cx, word [bp + 8]
    10 00000285 8B7606              <1> 	mov	si, word [bp + 6]
    11                              <1> 
    12 00000288 89F7                <1> 	mov	di, si
    13                              <1> .10A:
    14 0000028A B020                <1> 	mov	al, ' '
    15 0000028C F7C30400            <1> 	test	bx, 0b0100
    16 00000290 7402                <1> 	je	.42E
    17 00000292 B030                <1> 	mov	al, '0'
    18                              <1> .42E:
    19 00000294 FC                  <1> 	cld
    20 00000295 F3AA                <1> 	rep	stosb
    21                              <1> 	; ' '„ÅßÂüã„ÇÅ„Çã
    22                              <1> 
    23 00000297 8B4604              <1> 	mov	ax, [bp + 4]
    24 0000029A 8B4E08              <1> 	mov	cx, [bp + 8]
    25 0000029D 89F7                <1> 	mov	di, si
    26 0000029F 01CF                <1> 	add	di, cx
    27                              <1> 	; DI = BUF + size. „Éê„ÉÉ„Éï„Ç°„ÅÆÊúÄÂæå
    28 000002A1 4F                  <1> 	dec	di
    29                              <1> 
    30 000002A2 F7C30100            <1> 	test	bx, 0b0001	; Á¨¶Âè∑‰ªò„Åç„Åã
    31 000002A6 7408                <1> 	je	.10E
    32 000002A8 83F800              <1> 	cmp	ax, 0
    33 000002AB 7D03                <1> 	jge	.10E		; Á¨¶Âè∑‰ªò„Åç„ÅßË≤†
    34 000002AD 83CB02              <1> 	or	bx, 0b0010	; Á¨¶Âè∑‰ªò„Åç„ÅÆ„Éì„ÉÉ„Éà„ÇíÁ´ã„Å¶„Çã
    35                              <1> .10E:
    36 000002B0 F7C30200            <1> 	test	bx, 0b0010
    37 000002B4 7410                <1> 	jz	.20E		; Á¨¶Âè∑„ÇíÊèèÁîª„Åó„Å™„ÅÑ->20E
    38 000002B6 83F800              <1> 	cmp	ax, 0
    39 000002B9 7D07                <1> 	jge	.22F
    40 000002BB F7D8                <1> 	neg	ax
    41 000002BD C6042D              <1> 	mov	[si], byte '-'
    42 000002C0 EB03                <1> 	jmp	.22E
    43                              <1> .22F:
    44 000002C2 C6042B              <1> 	mov	[si], byte '+'
    45                              <1> .22E:
    46 000002C5 49                  <1> 	dec	cx
    47                              <1> .20E:
    48 000002C6 8B5E0A              <1> 	mov	bx, [bp + 10]
    49                              <1> .30L:
    50 000002C9 BA0000              <1> 	mov	dx, 0
    51 000002CC F7F3                <1> 	div	bx
    52                              <1> 	; AX„ÇíBX(radix)„ÅßÂâ≤„Çã
    53                              <1> 	; DX -> „ÅÇ„Åæ„Çä, AX -> ÂïÜ
    54                              <1> 
    55 000002CE 89D6                <1> 	mov	si, dx
    56 000002D0 8A94[E102]          <1> 	mov	dl, byte [.ascii + si]
    57                              <1> 
    58 000002D4 8815                <1> 	mov	[di], dl
    59 000002D6 4F                  <1> 	dec	di
    60                              <1> 
    61 000002D7 83F800              <1> 	cmp	ax, 0
    62 000002DA E0ED                <1> 	loopnz	.30L
    63                              <1> .40A:
    64 000002DC 61                  <1> 	popa
    65                              <1> 
    66 000002DD 89EC                <1> 	mov	sp, bp
    67 000002DF 5D                  <1> 	pop	bp
    68                              <1> 
    69 000002E0 C3                  <1> 	ret
    70                              <1> 
    71 000002E1 303132333435363738- <1> .ascii:	db	"0123456789ABCDEF"
    71 000002EA 39414243444546      <1>
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    95                                  %include	"modules/real/get_mem_info.s"
     1                              <1> get_mem_info:
     2 000002F1 6650                <1> 	push	eax
     3 000002F3 6653                <1> 	push	ebx
     4 000002F5 6651                <1> 	push	ecx
     5 000002F7 6652                <1> 	push	edx
     6 000002F9 56                  <1> 	push	si
     7 000002FA 57                  <1> 	push	di
     8 000002FB 55                  <1> 	push	bp
     9                              <1> 
    10 000002FC 68[A403]E8F0FD83C4- <1> 	cdecl	puts, .s0
    10 00000304 02                  <1>
    11                              <1> 
    12 00000305 BD0000              <1> 	mov	bp, 0
    13 00000308 66BB00000000        <1> 	mov	ebx, 0
    14                              <1> .10L:
    15 0000030E 66B820E80000        <1> 	mov	eax, 0x0000E820
    16 00000314 66B914000000        <1> 	mov	ecx, E820_RECORD_SIZE
    17 0000031A 66BA50414D53        <1> 	mov	edx, 'PAMS'
    18 00000320 BF[9003]            <1> 	mov	di, .record
    19 00000323 CD15                <1> 	int	0x15
    20                              <1> 	; 15H:E820 -> "Query System Address Map"
    21                              <1> 	; http://www.uruk.org/orig-grub/mem64mb.html
    22                              <1> 	
    23 00000325 663D50414D53        <1> 	cmp	eax, 'PAMS'	; EAX„Å´Ë≠òÂà•Â≠ê„ÅåËøî„Å£„Å¶„Åè„Çã„ÅÆ„ÅßÊØîËºÉ
    24                              <1> 
    25 0000032B 7402                <1> 	je	.12E
    26 0000032D EB4C                <1> 	jmp	.10E
    27                              <1> 	; „Ç®„É©„Éº
    28                              <1> .12E:
    29 0000032F 7302                <1> 	jnc	.14E
    30                              <1> 	; No Carry flag„ÅØ„Ç®„É©„Éº„ÅåËµ∑„Åç„Å¶„ÅÑ„Å™„ÅÑ
    31 00000331 EB48                <1> 	jmp	.10E
    32                              <1> 	; „Ç®„É©„Éº
    33                              <1> .14E:
    34 00000333 57E8F90083C402      <1> 	cdecl	put_mem_info, di
    35                              <1> 	; ES:DL„Åå„Éê„ÉÉ„Éï„Ç°„Éº„ÅÆ„Ç¢„Éâ„É¨„Çπ
    36                              <1> 
    37 0000033A 668B4510            <1> 	mov	eax, [di + 16]
    38                              <1> 	; „É¨„Ç≥„Éº„Éâ„Çø„Ç§„ÉóÂèñÂæó„ÄÇË©≥Á¥∞„ÅØp332
    39 0000033E 6683F803            <1> 	cmp	eax, 3
    40                              <1> 	; EAX=3 ACPI„ÉÜ„Éº„Éñ„É´ÂèÇÁÖßÂèØËÉΩ
    41 00000342 750F                <1> 	jne	.15E
    42                              <1> 	
    43 00000344 668B05              <1> 	mov	eax, [di + 0]
    44                              <1> 	; „Éô„Éº„Çπ„Ç¢„Éâ„É¨„Çπ(8bytes)
    45 00000347 66A3[0402]          <1> 	mov	[ACPI_DATA.adr], eax
    46 0000034B 668B4508            <1> 	mov	eax, [di + 8]
    47                              <1> 	; Èï∑„Åï(8bytes)
    48 0000034F 66A3[0802]          <1> 	mov	[ACPI_DATA.len], eax
    49                              <1> .15E:
    50 00000353 6683FB00            <1> 	cmp	ebx, 0
    51 00000357 741C                <1> 	jz	.16E
    52                              <1> 
    53 00000359 45                  <1> 	inc	bp
    54                              <1> 	; bp„ÅØ„É©„Ç§„É≥„ÅÆ„Ç´„Ç¶„É≥„Çø„Éº
    55 0000035A 83E507              <1> 	and	bp,0x07
    56 0000035D 7516                <1> 	jnz	.16E
    57                              <1> 
    58 0000035F 68[1704]E88DFD83C4- <1> 	cdecl	puts, .s2
    58 00000367 02                  <1>
    59 00000368 B410                <1> 	mov	ah,0x10
    60 0000036A CD16                <1> 	int	0x16
    61                              <1> 	; „Ç≠„ÉºÂÖ•ÂäõÂæÖ„Å°
    62 0000036C 68[2204]E880FD83C4- <1> 	cdecl	puts, .s3
    62 00000374 02                  <1>
    63                              <1> .16E:
    64 00000375 6683FB00            <1> 	cmp	ebx,0
    65 00000379 7593                <1> 	jne	.10L
    66                              <1> 	; ÊúÄÁµÇ„Éá„Éº„Çø„Åò„ÇÉ„Å™„ÅÑ
    67                              <1> .10E:
    68 0000037B 68[E703]E871FD83C4- <1> 	cdecl	puts, .s1
    68 00000383 02                  <1>
    69 00000384 5D                  <1> 	pop	bp
    70 00000385 5F                  <1> 	pop	di
    71 00000386 5E                  <1> 	pop	si
    72 00000387 665A                <1> 	pop	edx
    73 00000389 6659                <1> 	pop	ecx
    74 0000038B 665B                <1> 	pop	ebx
    75 0000038D 6658                <1> 	pop	eax
    76                              <1> 
    77 0000038F C3                  <1> 	ret
    78                              <1> 
    79                              <1> ALIGN 	4,	db 	0
    80 00000390 00<rept>            <1> .record: times E820_RECORD_SIZE	db	00
    81 000003A4 2045383230204D656D- <1> .s0:	db " E820 Memory Map:", 0x0A, 0x0D
    81 000003AD 6F7279204D61703A0A- <1>
    81 000003B6 0D                  <1>
    82 000003B7 20426173655F5F5F5F- <1> 	db " Base_____________ Length___________ Type____", 0x0A, 0x0D, 0
    82 000003C0 5F5F5F5F5F5F5F5F5F- <1>
    82 000003C9 204C656E6774685F5F- <1>
    82 000003D2 5F5F5F5F5F5F5F5F5F- <1>
    82 000003DB 20547970655F5F5F5F- <1>
    82 000003E4 0A0D00              <1>
    83 000003E7 202D2D2D2D2D2D2D2D- <1> .s1:	db " ----------------- ----------------- --------", 0x0A, 0x0D, 0
    83 000003F0 2D2D2D2D2D2D2D2D2D- <1>
    83 000003F9 202D2D2D2D2D2D2D2D- <1>
    83 00000402 2D2D2D2D2D2D2D2D2D- <1>
    83 0000040B 202D2D2D2D2D2D2D2D- <1>
    83 00000414 0A0D00              <1>
    84 00000417 203C6D6F72652E2E2E- <1> .s2:	db	" <more...>", 0
    84 00000420 3E00                <1>
    85 00000422 0D2020202020202020- <1> .s3:	db	0x0D, "           ",0x0D,0
    85 0000042B 2020200D00          <1>
    86                              <1> 
    87                              <1> put_mem_info:
    88                              <1> ; put_mem_info(memory_info_adr)	
    89 00000430 55                  <1> 	push	bp
    90 00000431 89E5                <1> 	mov	bp,sp
    91                              <1> 
    92 00000433 53                  <1> 	push	bx
    93 00000434 56                  <1> 	push	si
    94                              <1> 
    95 00000435 8B7604              <1> 	mov	si, [bp + 4]
    96 00000438 6A046A106A0468-     <1> 	cdecl	itoa, word [si + 6], .p2 + 0, 4, 16, 0b0100
    96 0000043F [0F05]FF7406E834FE- <1>
    96 00000447 83C40A              <1>
    97 0000044A 6A046A106A0468-     <1> 	cdecl	itoa, word [si + 4], .p2 + 4, 4, 16, 0b0100
    97 00000451 [1305]FF7404E822FE- <1>
    97 00000459 83C40A              <1>
    98 0000045C 6A046A106A0468-     <1> 	cdecl	itoa, word [si + 2], .p3 + 0, 4, 16, 0b0100
    98 00000463 [1805]FF7402E810FE- <1>
    98 0000046B 83C40A              <1>
    99 0000046E 6A046A106A0468-     <1> 	cdecl	itoa, word [si + 0], .p3 + 4, 4, 16, 0b0100
    99 00000475 [1C05]FF34E8FFFD83- <1>
    99 0000047D C40A                <1>
   100                              <1> 
   101 0000047F 6A046A106A0468-     <1> 	cdecl	itoa, word [si +14], .p4 + 0, 4, 16, 0b0100
   101 00000486 [2105]FF740EE8EDFD- <1>
   101 0000048E 83C40A              <1>
   102 00000491 6A046A106A0468-     <1> 	cdecl	itoa, word [si +12], .p4 + 4, 4, 16, 0b0100
   102 00000498 [2505]FF740CE8DBFD- <1>
   102 000004A0 83C40A              <1>
   103 000004A3 6A046A106A0468-     <1> 	cdecl	itoa, word [si +10], .p5 + 0, 4, 16, 0b0100
   103 000004AA [2A05]FF740AE8C9FD- <1>
   103 000004B2 83C40A              <1>
   104 000004B5 6A046A106A0468-     <1> 	cdecl	itoa, word [si + 8], .p5 + 4, 4, 16, 0b0100
   104 000004BC [2E05]FF7408E8B7FD- <1>
   104 000004C4 83C40A              <1>
   105                              <1> 
   106 000004C7 6A046A106A0468-     <1> 	cdecl	itoa, word [si +18], .p6 + 0, 4, 16, 0b0100
   106 000004CE [3305]FF7412E8A5FD- <1>
   106 000004D6 83C40A              <1>
   107 000004D9 6A046A106A0468-     <1> 	cdecl	itoa, word [si +16], .p6 + 4, 4, 16, 0b0100
   107 000004E0 [3705]FF7410E893FD- <1>
   107 000004E8 83C40A              <1>
   108                              <1> 
   109 000004EB 68[0E05]E801FC83C4- <1> 	cdecl	puts, .s1
   109 000004F3 02                  <1>
   110                              <1> 
   111 000004F4 8B5C10              <1> 	mov	bx, [si +16]
   112 000004F7 83E307              <1> 	and	bx, 0x07
   113 000004FA D1E3                <1> 	shl	bx, 1
   114 000004FC 81C3[9005]          <1> 	add	bx, .t0
   115 00000500 FF37E8EDFB83C402    <1> 	cdecl	puts, word[bx]
   116                              <1> 
   117 00000508 5E                  <1> 	pop	si
   118 00000509 5B                  <1> 	pop	bx
   119                              <1> 
   120 0000050A 89EC                <1> 	mov	sp,bp
   121 0000050C 5D                  <1> 	pop	bp
   122                              <1> 
   123 0000050D C3                  <1> 	ret
   124                              <1> 
   125 0000050E 20                  <1> .s1:	db	" "
   126 0000050F 5A5A5A5A5A5A5A5A5F  <1> .p2:	db	"ZZZZZZZZ_"
   127 00000518 5A5A5A5A5A5A5A5A20  <1> .p3:	db	"ZZZZZZZZ "
   128 00000521 5A5A5A5A5A5A5A5A5F  <1> .p4:	db	"ZZZZZZZZ_"
   129 0000052A 5A5A5A5A5A5A5A5A20  <1> .p5:	db	"ZZZZZZZZ "
   130 00000533 5A5A5A5A5A5A5A5A00  <1> .p6:	db	"ZZZZZZZZ",0
   131                              <1> 
   132 0000053C 2028556E6B6E6F776E- <1> .s4:	db	" (Unknown)",0x0A,0x0D,0
   132 00000545 290A0D00            <1>
   133 00000549 2028557361626C6529- <1> .s5:	db	" (Usable)",0x0A,0x0D,0
   133 00000552 0A0D00              <1>
   134 00000555 202852657365727665- <1> .s6:	db	" (Reserved)",0x0A,0x0D,0
   134 0000055E 64290A0D00          <1>
   135 00000563 202841435049206461- <1> .s7:	db	" (ACPI data)",0x0A,0x0D,0
   135 0000056C 7461290A0D00        <1>
   136 00000572 202841435049204E56- <1> .s8:	db	" (ACPI NVS)",0x0A,0x0D,0
   136 0000057B 53290A0D00          <1>
   137 00000580 2028426164206D656D- <1> .s9:	db	" (Bad memory)",0x0A,0x0D,0
   137 00000589 6F7279290A0D00      <1>
   138                              <1> 
   139 00000590 [3C05][4905][5505]- <1> .t0:	dw	.s4, .s5, .s6, .s7, .s8, .s9, .s4, .s4
   139 00000596 [6305][7205][8005]- <1>
   139 0000059C [3C05][3C05]        <1>
   140                              <1> 
   141 000005A0 20202020202000      <1> .t1:	db	"      ",0
   142                              <1> 
    96                                  %include	"modules/real/kbc.s"
     1                              <1> KBC_Data_Write:
     2                              <1> ; KBC_Data_Write(data)
     3 000005A7 55                  <1> 	push	bp
     4 000005A8 89E5                <1> 	mov	bp, sp
     5 000005AA 51                  <1> 	push	cx
     6 000005AB B90000              <1> 	mov	cx, 0
     7                              <1> 	; CX„ÇíÊ∏õÁÆó„Åó„Å™„Åå„ÇâÂá¶ÁêÜ„Åô„Çã„Åü„ÇÅ„ÄÅ0 - 1 = 0xFFFF
     8                              <1> .10L:
     9 000005AE E464                <1> 	in	al, 0x64
    10                              <1> 	; 0x64„ÅÆË™≠„ÅøËæº„Åø„ÅØ„Çπ„ÉÜ„Éº„Çø„ÇπÂèñÂæó
    11 000005B0 A802                <1> 	test	al, 0x02
    12                              <1> 	; „Ç∑„Çπ„ÉÜ„É†„Éï„É©„Ç∞
    13                              <1> 	; „Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø„ÅÆË©≥Á¥∞„ÅØp293
    14 000005B2 E0FA                <1> 	loopnz	.10L
    15                              <1> 	; CX„Åå0„Å™„Çâ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
    16                              <1> 	; ZF„Åå0„Å™„Çâ„Éá„Éº„ÇøÊõ∏„ÅçËæº„ÇÄÂèØËÉΩ
    17                              <1> 
    18 000005B4 83F900              <1> 	cmp	cx, 0
    19 000005B7 7405                <1> 	je	.20E
    20                              <1> 	; „Çø„Ç§„É†„Ç¢„Ç¶„Éà
    21                              <1> 
    22 000005B9 8A4604              <1> 	mov	al, [bp + 4]	; Êõ∏„ÅçËæº„ÇÄ„Éá„Éº„Çø
    23 000005BC E660                <1> 	out	0x60, al
    24                              <1> .20E:
    25 000005BE 89C8                <1> 	mov	ax, cx		; „É™„Ç∂„É´„Éà(0„Å™„Çâ„Çø„Ç§„É†„Ç¢„Ç¶„Éà)
    26 000005C0 59                  <1> 	pop	cx
    27 000005C1 89EC                <1> 	mov	sp, bp
    28 000005C3 5D                  <1> 	pop	bp
    29 000005C4 C3                  <1> 	ret
    30                              <1> KBC_Cmd_Write:
    31                              <1> ; KBC_Cmd_Write(cmd_data)
    32 000005C5 55                  <1> 	push	bp
    33 000005C6 89E5                <1> 	mov	bp, sp
    34 000005C8 51                  <1> 	push	cx
    35                              <1> 
    36 000005C9 B90000              <1> 	mov	cx, 0	; ‰∏ä„Å´Âêå„Åò
    37                              <1> .10L:
    38 000005CC E464                <1> 	in	al, 0x64
    39 000005CE A802                <1> 	test	al, 0x02
    40 000005D0 E0FA                <1> 	loopnz	.10L
    41                              <1> 
    42 000005D2 83F900              <1> 	cmp	cx, 0
    43 000005D5 7405                <1> 	jz	.20E
    44                              <1> 
    45 000005D7 8A4604              <1> 	mov	al, [bp + 4]
    46 000005DA E664                <1> 	out	0x64, al
    47                              <1> 	; 0x64„ÅÆÊõ∏„ÅçËæº„Åø„ÅØ„Ç≥„Éû„É≥„Éâ
    48                              <1> .20E:
    49 000005DC 89C8                <1> 	mov	ax, cx
    50 000005DE 59                  <1> 	pop	cx
    51 000005DF 89EC                <1> 	mov	sp, bp
    52 000005E1 5D                  <1> 	pop	bp
    53 000005E2 C3                  <1> 	ret
    54                              <1> 
    55                              <1> KBC_Data_Read:
    56                              <1> ; KBC_Data_Read(data_adr)
    57 000005E3 55                  <1> 	push	bp
    58 000005E4 89E5                <1> 	mov	bp, sp
    59 000005E6 51                  <1> 	push	cx
    60 000005E7 B90000              <1> 	mov	cx, 0
    61                              <1> .10L:
    62 000005EA E464                <1> 	in	al, 0x64
    63 000005EC A801                <1> 	test	al, 0x01
    64                              <1> 	; 0x01„ÅØÂÖ•Âäõ„Éê„ÉÉ„Éï„Ç°„Éï„É´„ÇíÁ¢∫Ë™ç
    65 000005EE E1FA                <1> 	loopz	.10L
    66                              <1> 
    67 000005F0 83F900              <1> 	cmp	cx, 0
    68 000005F3 7409                <1> 	jz	.20E
    69                              <1> 
    70 000005F5 B400                <1> 	mov	ah, 0x00
    71 000005F7 E460                <1> 	in	al, 0x60
    72                              <1> 	; 0x60(data)„ÅÆË™≠„ÅøËæº„Åø
    73                              <1> 
    74 000005F9 8B7E04              <1> 	mov	di, [bp + 4]
    75 000005FC 8905                <1> 	mov	[di + 0], ax
    76                              <1> .20E:
    77 000005FE 89C8                <1> 	mov	ax, cx
    78 00000600 59                  <1> 	pop	cx
    79 00000601 89EC                <1> 	mov	sp, bp
    80 00000603 5D                  <1> 	pop	bp
    81 00000604 C3                  <1> 	ret
    82                              <1> 
    97                                  %include	"modules/real/lba_chs.s"
     1                              <1> lba_chs:
     2                              <1> ; lba_chs(drive_param, drive_adr, lba)
     3 00000605 55                  <1> 	push	bp
     4 00000606 89E5                <1> 	mov	bp, sp
     5 00000608 56                  <1> 	push	si
     6 00000609 50                  <1> 	push	ax
     7 0000060A 52                  <1> 	push	dx
     8 0000060B 53                  <1> 	push	bx
     9 0000060C 57                  <1> 	push	di
    10                              <1> 
    11 0000060D 8B7604              <1> 	mov	si, [bp + 4]
    12 00000610 8B7E06              <1> 	mov	di, [bp + 6]
    13                              <1> 
    14 00000613 8A4404              <1> 	mov	al, [si + drive.head]
    15 00000616 F66406              <1> 	mul	byte [si + drive.sect]
    16                              <1> 	; AX„ÅØ„Éò„ÉÉ„ÉâÊï∞*„Çª„ÇØ„ÇøÊï∞=Á∑è„Çª„ÇØ„ÇøÊï∞(„Ç∑„É™„É≥„ÉÄÂΩì„Åü„Çä)
    17 00000619 89C3                <1> 	mov	bx, ax
    18 0000061B BA0000              <1> 	mov	dx, 0
    19 0000061E 8B4608              <1> 	mov	ax, [bp + 8]
    20                              <1> 	; LBA
    21 00000621 F7F3                <1> 	div	bx
    22                              <1> 	; BX„Åß„Çè„Å£„Å¶„ÇÑ„Çã„ÄÇ
    23                              <1> 	; ÂïÜ(AX)„ÅØ„Ç∑„É™„É≥„ÉÄÊï∞
    24                              <1> 	; „ÅÇ„Åæ„Çä(DX)„ÅØ„Éò„ÉÉ„ÉâÊï∞
    25                              <1> 
    26 00000623 894502              <1> 	mov	[di + drive.cyln], ax
    27 00000626 89D0                <1> 	mov	ax, dx
    28 00000628 F67406              <1> 	div	byte [si + drive.sect]
    29                              <1> 	; Âêå„Åò„Çà„ÅÜ„Å´„ÄÅÊ¨°„ÅØ„Çª„ÇØ„ÇøÊï∞„ÅßÂâ≤„Å£„Å¶„ÇÑ„Çã
    30                              <1> 	; ÂïÜ(AL)„ÅØ„Éò„ÉÉ„ÉâÊï∞
    31                              <1> 	; „ÅÇ„Åæ„Çä(AH)„ÅØ„Çª„ÇØ„ÇøÊï∞
    32 0000062B 0FB6D4              <1> 	movzx	dx, ah
    33 0000062E 42                  <1> 	inc	dx
    34 0000062F B400                <1> 	mov	ah, 0x00
    35 00000631 894504              <1> 	mov	[di + drive.head], ax
    36                              <1> 	; AH = 0„Çà„Çä„ÄÅAX = AL
    37 00000634 895506              <1> 	mov	[di + drive.sect], dx
    38                              <1> 	
    39 00000637 5F                  <1> 	pop	di
    40 00000638 5B                  <1> 	pop	bx
    41 00000639 5A                  <1> 	pop	dx
    42 0000063A 58                  <1> 	pop	ax
    43 0000063B 5E                  <1> 	pop	si
    44                              <1> 
    45 0000063C 89EC                <1> 	mov	sp, bp
    46 0000063E 5D                  <1> 	pop	bp
    47                              <1> 
    48 0000063F C3                  <1> 	ret
    98                                  %include	"modules/real/read_lba.s"
     1                              <1> read_lba:
     2                              <1> ; read_lba(drive_param, lba, read_sector, dst_adr)
     3 00000640 55                  <1> 	push	bp
     4 00000641 89E5                <1> 	mov	bp, sp
     5 00000643 56                  <1> 	push	si
     6                              <1> 
     7 00000644 8B7604              <1> 	mov	si, [bp + 4] ; „Éë„É©„É°„Çø
     8 00000647 8B4606              <1> 	mov	ax, [bp + 6] ; LBA
     9                              <1> 
    10 0000064A 5068[6E06]56E8B3FF- <1> 	cdecl	lba_chs, word si, .chs, word ax
    10 00000652 83C406              <1>
    11                              <1> 
    12 00000655 8A04                <1> 	mov	al, [si + drive.no]
    13 00000657 A2[6E06]            <1> 	mov	[.chs + drive.no], al
    14                              <1> 	; .chs„Å´„Éä„É≥„Éê„Éº„ÅØ„Çª„ÉÉ„Éà„Åó„Å¶„ÇÑ„Çã(lba_chs„Åß„ÅØ„ÇÑ„Å£„Å¶„Åè„Çå„Å™„ÅÑ)
    15                              <1> 
    16 0000065A FF760AFF760868-     <1> 	cdecl	read_chs, .chs, word [bp + 8], word [bp + 10]
    16 00000661 [6E06]E840FA83C406  <1>
    17 00000669 5E                  <1> 	pop	si
    18 0000066A 89EC                <1> 	mov	sp, bp
    19 0000066C 5D                  <1> 	pop	bp
    20 0000066D C3                  <1> 	ret
    21                              <1> ALIGN	2
    22 0000066E 00<rept>            <1> .chs:	times	drive_size	db	0
    99                                  
   100                                  main_boot_program:
   101 00000676 68[9E00]E890FB83C4-     	cdecl	get_drive_param, BOOT_DRIVE
   101 0000067E 02                 
   102                                  	; BOOT_DRIVE„Å´‰Ωø„Å£„Å¶„ÅÑ„Çã„Éâ„É©„Ç§„Éñ„ÅÆÊÉÖÂ†±„ÇíÂÖ•„Çå„Çã
   103 0000067F 83F800                  	cmp	ax, 0
   104 00000682 750C                    	jne	.10E	; ÊàêÂäü
   105 00000684 68[A907]E868FA83C4-     	cdecl	puts, errmsg_read_drive
   105 0000068C 02                 
   106 0000068D E881FA                  	call	reboot
   107                                  .10E:
   108 00000690 68[0002]E8C5FB83C4-     	cdecl	get_font_adr, FONT
   108 00000698 02                 
   109                                  	; BISO„ÅÆ„Éï„Ç©„É≥„ÉàÂèñÂæó(Protected-Mode„Åß„ÇÇ‰Ωø„Åà„Çã„Çà„ÅÜ„Å´)
   110 00000699 E855FC                  	cdecl	get_mem_info
   111                                  	; RAM„Å´ÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„ÇãÊÉÖÂ†±„ÇíÂæó„Çã
   112                                  
   113 0000069C 66A1[0402]              	mov	eax, [ACPI_DATA.adr]
   114 000006A0 6683F800                	cmp	eax, 0
   115 000006A4 7409                    	je	.20E
   116                                  	; ACPIÂà©Áî®‰∏çÂèØ
   117 000006A6 68[9807]E846FA83C4-     	cdecl	puts, msg_able_to_use_acpi
   117 000006AE 02                 
   118                                  .20E:
   119                                  	; A20 ÊúâÂäπÂåñ(KBC„Çí‰Ωø„ÅÜ)
   120 000006AF FA                      	cli	; „Åæ„ÅöÂâ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢
   121 000006B0 68AD00E80FFF83C402      	cdecl	KBC_Cmd_Write, 0xAD
   122                                  	; „Ç≠„Éº„Éú„Éº„Éâ„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„ÇπÁÑ°Âäπ
   123 000006B9 68D000E806FF83C402      	cdecl	KBC_Cmd_Write, 0xD0
   124                                  	; Âá∫Âäõ„Éù„Éº„ÉàË™≠„ÅøÂá∫„Åó
   125 000006C2 68[E507]E81BFF83C4-     	cdecl	KBC_Data_Read, kbc_register_key
   125 000006CA 02                 
   126                                  
   127 000006CB 8A1E[E507]              	mov	bl, [kbc_register_key]
   128 000006CF 80CB02                  	or	bl, 0x02
   129                                  	; KBC„ÅÆ„É¨„Ç∏„Çπ„Çø„ÅÆB2„ÅØA20ÊúâÂäπÂåñ„Éì„ÉÉ„Éà„Å´„Å™„Å£„Å¶„ÅÑ„Çã
   130 000006D2 68D100E8EDFE83C402      	cdecl	KBC_Cmd_Write, 0xD1
   131                                  	; Êõ∏„ÅçËæº„Åø„É¢„Éº„Éâ
   132 000006DB 53E8C8FE83C402          	cdecl	KBC_Data_Write, bx
   133                                  	; A20Êõ∏„ÅçËæº„Åø
   134 000006E2 68AE00E8DDFE83C402      	cdecl	KBC_Cmd_Write, 0xAE
   135                                  	; ÂÜçÊúâÂäπÂåñ
   136 000006EB FB                      	sti
   137                                  
   138 000006EC B81200                  	mov	ax, 0x0012
   139 000006EF CD10                    	int	0x10
   140                                  	; 10H:12H „Éì„Éá„Ç™„É¢„Éº„Éâ„ÅÆÂ§âÊõ¥„ÄÇ„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ„É¢„Éº„Éâ„Å´„Åô„Çã„ÄÇ
   141                                  
   142                                  	; „Ç´„Éº„Éç„É´„ÅÆË™≠„ÅøËæº„ÅøÂá¶ÁêÜ
   143 000006F1 68009C6A306A1068-       	cdecl	read_lba, BOOT_DRIVE, BOOT_SECT, KERNEL_SECT, BOOT_END
   143 000006F9 [9E00]E842FF83C408 
   144 00000701 83F830                  	cmp	ax, KERNEL_SECT
   145 00000704 740C                    	jz	.30E
   146 00000706 68[C807]E8E6F983C4-     	cdecl	puts, errmsg_read_kernel
   146 0000070E 02                 
   147 0000070F E8FFF9                  	call	reboot
   148                                  .30E:
   149                                  	; „Ç´„Éº„Éç„É´„ÅÆË™≠„ÅøËæº„Åø„ÅåÂÆå‰∫Ü
   150                                  	; Protected-Mode„Å∏„ÅÆÁßªË°å„ÇíÈñãÂßã
   151                                  
   152 00000712 FA                      	cli
   153 00000713 0F0116[8407]            	lgdt	[GDTR]	; GDTR„Çí„Çª„ÉÉ„Éà
   154 00000718 0F011E[8A07]            	lidt	[IDTR]
   155 0000071D 0F20C0                  	mov	eax, cr0
   156                                  	; Âà∂Âæ°„É¨„Ç∏„Çπ„Çø„ÇíÂèñÂæó
   157 00000720 6683C801                	or	eax, 1
   158                                  	; Protected-ModeÊúâÂäπÂåñ„Éì„ÉÉ„Éà„ÇíÁ´ã„Å¶„Çã
   159 00000724 0F22C0                  	mov	cr0, eax
   160                                  
   161 00000727 EB00                    	jmp	$ + 2
   162                                  	; „Éë„Ç§„Éó„É©„Ç§„É≥„ÅÆÂÜÖÂÆπ„ÇíÁ†¥Ê£Ñ
   163                                  
   164                                  [BITS 32]	; 32bit„É¢„Éº„Éâ„ÅÆÊ©üÊ¢∞Ë™û„ÅÆÂá∫Âäõ„ÇíÊåáÁ§∫
   165 00000729 66                      	db	0x66
   166                                  	; Real-Mode„Åße*x„É¨„Ç∏„Çπ„Çø„ÅÆ‰ΩøÁî®„ÇíÂèØËÉΩ„Å´„Åô„Çã„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ
   167 0000072A EA[31070000]0800        	jmp	SEL_CODE:CODE_32
   168                                  	; ip„ÇíÂèÇÁÖß„Åô„Çã„Å®„ÅçSEL_CODE„Çí„Çª„Ç∞„É°„É≥„Éà„Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø„Å´„Åô„Çã
   169                                  CODE_32:
   170 00000731 66B81000                	mov	ax, SEL_DATA
   171 00000735 8ED8                    	mov	ds, ax
   172 00000737 8EC0                    	mov	es, ax
   173 00000739 8EE0                    	mov	fs, ax
   174 0000073B 8EE8                    	mov	gs, ax
   175 0000073D 8ED0                    	mov	ss, ax
   176                                  	; GS,SS„ÅØES„ÅÆ„Åï„Çâ„Å™„ÇãËøΩÂä†
   177                                  
   178                                  	; BOOT_END„Å´ËøΩÂä†„Åï„Çå„Åü„É°„É¢„É™„ÇíKERNELÈ†òÂüü„Å´Êõ∏„ÅçËæº„ÇÄ
   179 0000073F B900180000              	mov	ecx, (KERNEL_SIZE) / 4
   180                                  	; „Éê„Ç§„ÉàÊï∞„ÇíÂèñÂæó
   181 00000744 BE009C0000              	mov	esi, BOOT_END
   182                                  	; „Å©„Åì„Åã„Çâ„Ç≥„Éî„Éº„Åô„Çã„Åã
   183 00000749 BF00000100              	mov	edi, KERNEL_LOAD
   184 0000074E FC                      	cld
   185 0000074F F3A5                    	rep	movsd
   186                                  
   187 00000751 FF2500000100            	jmp	[KERNEL_LOAD]
   188                                  
   189 00000757 2D2D2D2D2D2D2D2D00      s0:	db	"--------", 0
   190 00000760 2D2D2D2D2D2D2D2D00      s1:	db	"--------", 0
   191                                  
   192                                  
   193 00000769 00<rept>                ALIGN	4,	db	0
   194                                  ; ‰∏ÄÊôÇÁöÑ„Å™GDT„Çí‰ΩúÊàê
   195 0000076C 0000000000000000        GDT:	dq	0x00_0000_000000_0000	; NULL
   196 00000774 FFFF0000009ACF00        .cs:	dq	0x00_CF9A_000000_FFFF	; CODE(4G)
   197 0000077C FFFF00000092CF00        .ds:	dq	0x00_CF92_000000_FFFF	; DATA(4G)
   198                                  .gdt_end:
   199                                  
   200                                  SEL_CODE	equ	GDT.cs - GDT
   201                                  SEL_DATA	equ	GDT.ds - GDT
   202                                  ; ÂêÑ„Éá„Ç£„Çπ„ÇØ„É™„Éó„Çø„ÅÆ„Çª„É¨„ÇØ„Çø(GDT„Åã„Çâ„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà)
   203                                  
   204 00000784 1700                    GDTR:	dw	GDT.gdt_end - GDT - 1
   205 00000786 [6C070000]              	dd	GDT
   206                                  ; „É™„Éü„ÉÉ„Çø„Å®„Ç¢„Éâ„É¨„Çπ
   207 0000078A 0000                    IDTR:	dw	0
   208 0000078C 00000000                	dd	0
   209                                  ; „É™„Éü„ÉÉ„Çø„Åå0„Å™„ÅÆ„ÅßÂâ≤„ÇäËæº„Åø„ÅØÁÑ°Âäπ
   210                                  	
   211 00000790 7375636365737300        suc:			db	"success", 0
   212 00000798 414350492061766169-     msg_able_to_use_acpi	db	"ACPI available", 0x0D, 0x0A, 0
   212 000007A1 6C61626C650D0A00   
   213                                  
   214 000007A9 436F756C64206E6F74-     errmsg_read_drive:	db	"Could not get drive parameter.", 0,
   214 000007B2 206765742064726976-
   214 000007BB 6520706172616D6574-
   214 000007C4 65722E00           
   215 000007C8 436F756C64206E6F74-     errmsg_read_kernel	db	"Could not load kernel binary", 0
   215 000007D1 206C6F6164206B6572-
   215 000007DA 6E656C2062696E6172-
   215 000007E3 7900               
   216 000007E5 0000                    kbc_register_key:	dw	0
   217                                  
   218 000007E7 00<rept>                times	BOOT_SIZE - ($ - $$)	db	0
   219                                  
   220                                  ; Memory Map
   221                                  ;+-------------+0
   222                                  ;|interrupt+etc|
   223                                  ;+-------------+??
   224                                  ;|none or stack|
   225                                  ;+-------------+07C00
   226                                  ;|boot program |
   227                                  ;+-------------+09C00
   228                                  ;| copy kernel |
   229                                  ;+-------------+0FC00
   230                                  ;|   not use   |
   231                                  ;+-------------+10000
   232                                  ;| kernel code |
   233                                  ;+-------------+
